# TritonTube 系统架构

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        TritonTube 系统架构                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Web 客户端     │    │   管理员工具     │    │   外部用户      │
│  (浏览器)       │    │  (命令行)       │    │  (视频上传)     │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          │ HTTP/HTTPS           │ gRPC                 │ HTTP
          │                      │                      │
          ▼                      ▼                      ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Web 服务器 (Port 8080)                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   HTTP 处理     │  │   视频上传      │  │   DASH 转换     │ │
│  │   - 视频列表    │  │   - 文件接收    │  │   - FFmpeg      │ │
│  │   - 视频播放    │  │   - 格式验证    │  │   - 分片生成    │ │
│  │   - 内容服务    │  │   - 元数据创建  │  │   - 存储分发    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  │ gRPC
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                管理服务 (Port 8081)                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   节点管理      │  │   数据迁移      │  │   一致性哈希    │ │
│  │   - 添加节点    │  │   - 负载均衡    │  │   - SHA-256     │ │
│  │   - 移除节点    │  │   - 故障转移    │  │   - 哈希环      │ │
│  │   - 状态监控    │  │   - 数据重分布  │  │   - 节点映射    │ │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘ │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  │ gRPC
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                    存储节点集群                                  │
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────┐ │
│  │ 节点 1      │  │ 节点 2      │  │ 节点 3      │  │ 节点 N  │ │
│  │ Port 8090   │  │ Port 8091   │  │ Port 8092   │  │ Port    │ │
│  │             │  │             │  │             │  │ 8090+N  │ │
│  │ ┌─────────┐ │  │ ┌─────────┐ │  │ ┌─────────┐ │  │         │ │
│  │ │ DASH 文件│ │  │ │ DASH 文件│ │  │ │ DASH 文件│ │  │ ┌─────┐ │ │
│  │ │ manifest│ │  │ │ manifest│ │  │ │ manifest│ │  │ │ ... │ │ │
│  │ │ .mpd    │ │  │ │ .mpd    │ │  │ │ .mpd    │ │  │ └─────┘ │ │
│  │ │ init-*.m4s│ │  │ │ init-*.m4s│ │  │ │ init-*.m4s│ │  │         │ │
│  │ │ chunk-*.m4s│ │  │ │ chunk-*.m4s│ │  │ │ chunk-*.m4s│ │  │         │ │
│  │ └─────────┘ │  │ └─────────┘ │  │ └─────────┘ │  │         │ │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────┘ │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      元数据存储                                  │
│  ┌─────────────────┐              ┌─────────────────┐            │
│  │   SQLite        │              │      etcd       │            │
│  │   - 视频信息    │              │   - 分布式元数据│            │
│  │   - 上传时间    │              │   - 配置管理    │            │
│  │   - 文件路径    │              │   - 服务发现    │            │
│  └─────────────────┘              └─────────────────┘            │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流图

### 视频上传流程

```
1. 用户上传视频文件
   ↓
2. Web 服务器接收文件
   ↓
3. 创建视频元数据 (SQLite/etcd)
   ↓
4. 临时存储文件
   ↓
5. FFmpeg 转换为 DASH 格式
   ├── manifest.mpd (清单文件)
   ├── init-0.m4s (初始化段)
   ├── init-1.m4s (初始化段)
   ├── chunk-0-*.m4s (视频段)
   └── chunk-1-*.m4s (音频段)
   ↓
6. 一致性哈希计算文件分布
   ↓
7. 分发文件到对应存储节点
   ↓
8. 清理临时文件
```

### 视频播放流程

```
1. 用户请求视频播放页面
   ↓
2. Web 服务器返回播放页面
   ↓
3. 浏览器请求 manifest.mpd
   ↓
4. 一致性哈希找到存储节点
   ↓
5. 返回 manifest.mpd
   ↓
6. 浏览器解析 manifest，请求媒体段
   ↓
7. 存储节点返回对应的 .m4s 文件
   ↓
8. 浏览器播放视频
```

### 节点管理流程

```
添加节点:
1. 管理员执行添加命令
   ↓
2. 管理服务连接到新节点
   ↓
3. 计算新节点的哈希值
   ↓
4. 更新一致性哈希环
   ↓
5. 计算需要迁移的文件
   ↓
6. 从其他节点迁移数据到新节点
   ↓
7. 更新文件分布映射

移除节点:
1. 管理员执行移除命令
   ↓
2. 管理服务识别受影响的文件
   ↓
3. 将文件迁移到其他节点
   ↓
4. 从哈希环中移除节点
   ↓
5. 关闭节点连接
```

## 一致性哈希算法

### 哈希环结构

```
哈希环 (0 到 2^64-1):
                    ┌─────────────────┐
                    │   文件 A        │
                    │   (hash: 100)   │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │   节点 1        │
                    │   (hash: 200)   │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │   文件 B        │
                    │   (hash: 300)   │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │   节点 2        │
                    │   (hash: 400)   │
                    └─────────┬───────┘
                              │
                    ┌─────────▼───────┐
                    │   文件 C        │
                    │   (hash: 500)   │
                    └─────────────────┘
```

### 文件分布策略

- **文件存储**: 文件存储在哈希环上顺时针方向的第一个节点
- **负载均衡**: 通过哈希分布实现数据均匀分布
- **故障容错**: 节点故障时，数据自动迁移到下一个可用节点
- **扩展性**: 新节点加入时，只影响部分数据迁移

## 技术特点

### 高可用性
- 多节点冗余存储
- 自动故障检测和恢复
- 数据自动迁移

### 可扩展性
- 水平扩展支持
- 动态节点管理
- 一致性哈希负载均衡

### 性能优化
- DASH 格式自适应流媒体
- 分片存储提高并发性能
- gRPC 高性能通信

### 数据一致性
- 事务性操作保证
- 分布式锁机制
- 定期健康检查

## 部署架构

### 单机部署
```
┌─────────────────────────────────────┐
│           单机环境                   │
│  ┌─────────┐  ┌─────────┐  ┌─────┐  │
│  │ Web服务 │  │ 管理服务│  │节点1│  │
│  │ :8080   │  │ :8081   │  │:8090│  │
│  └─────────┘  └─────────┘  └─────┘  │
│  ┌─────────┐  ┌─────────┐  ┌─────┐  │
│  │ 节点2   │  │ 节点3   │  │SQLite│ │
│  │ :8091   │  │ :8092   │  │     │ │
│  └─────────┘  └─────────┘  └─────┘  │
└─────────────────────────────────────┘
```

### 分布式部署
```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  服务器 1    │    │  服务器 2    │    │  服务器 3    │
│ ┌─────────┐ │    │ ┌─────────┐ │    │ ┌─────────┐ │
│ │ Web服务 │ │    │ │ 管理服务│ │    │ │ 存储节点│ │
│ │ :8080   │ │    │ │ :8081   │ │    │ │ :8090   │ │
│ └─────────┘ │    │ └─────────┘ │    │ └─────────┘ │
│ ┌─────────┐ │    │ ┌─────────┐ │    │ ┌─────────┐ │
│ │ 存储节点│ │    │ │ 存储节点│ │    │ │ 存储节点│ │
│ │ :8091   │ │    │ │ :8092   │ │    │ │ :8093   │ │
│ └─────────┘ │    │ └─────────┘ │    │ └─────────┘ │
└─────────────┘    └─────────────┘    └─────────────┘
        │                   │                   │
        └───────────────────┼───────────────────┘
                            │
                    ┌───────▼────────┐
                    │   etcd 集群    │
                    │  (元数据存储)   │
                    └────────────────┘
```
